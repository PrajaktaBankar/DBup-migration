/*
 Execute on Server 2
 Customer Support 71628: Corrupt choices and hierarchy issues in Project - 13594/729
 Resolved both issue
*/

UPDATE PSS set  PSS.ParentSegmentStatusId=1144208784  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208785)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208785  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208920,1144208786,1144208787,1144208788,1144208789,1144208790)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208649  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208791,1144208792,1144208793,1144208794,1144208795)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208795  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208796)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208655  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208797,1144208798)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208657  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208799,1144208800)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208659  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208801,1144208802,1144208803,1144208804,1144208805,1144208806,1144208807,1144208808,1144208809,1144208810,1144208811,1144208812,1144208813,1144208814,1144208815,1144208816,1144208817,1144208818,1144208819,1144208820,1144208821)

UPDATE PSS set  PSS.ParentSegmentStatusId=1144208648  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208822)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208822  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208823,1144208824,1144208825,1144208826,1144208827,1144208828)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208686  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208829,1144208830,1144208831,1144208832)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208691  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208833,1144208834)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208693  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208835,1144208836)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208695  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208837,1144208838)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208696  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208839,1144208840,1144208841,1144208842,1144208843,1144208844,1144208845,1144208846)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208648  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208847,1144208848)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208848  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208706,1144208707,1144208849,1144208850,1144208708,1144208709,1144208851,1144208852,1144208710)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208711  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208853,1144208854)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208712  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208855,1144208856,1144208857,1144208858,1144208859,1144208860,1144208861)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208861  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208862)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208721  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208863,1144208864)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208723  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208865,1144208866)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208725  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208867,1144208868,1144208869,1144208870,1144208871,1144208872,1144208873,1144208874,1144208875,1144208877,1144208876,1144208878,1144208879,1144208880,1144208881,1144208882,1144208883,1144208884,1144208885)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208648  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208886)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208886  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208744,1144208745,1144208887,1144208888,1144208889,1144208890,1144208891,1144208892)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208888  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208746,1144208747)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208886  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208748,1144208749)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208751  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208893,1144208894,1144208895,1144208896,1144208897,1144208898,1144208899,1144208900,1144208901,1144208902)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208759  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208903,1144208904,1144208905,1144208906,1144208907,1144208908)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208915  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208916)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208774  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208917,1144208918)
UPDATE PSS set  PSS.ParentSegmentStatusId=1144208776  from projectsegmentStatus as PSS where PSS.projectid=17623 and PSS.sectionId=22309717 and SegmentStatusId in (1144208919)

----------------------------------------------------------------------------------------------------------------------------

DECLARE @CustomerId int =729
DECLARE @ProjectId1 int =17623
  DROP TABLE if EXISTS #tempInsertMissingUserModificationMissingChoices
 CREATE table #tempInsertMissingUserModificationMissingChoices(ProjectId Int,RowNo Int)
 INSERT INTO #tempInsertMissingUserModificationMissingChoices (ProjectId  ,RowNo  )
select ProjectId,
ROW_NUMBER () over(PARTITION BY  CustomerId ORDER BY  CustomerId)as RowNo
 from 
project WITH(NOLOCK) WHERE  CustomerId=@CustomerId and ISNULL( IsPermanentDeleted,0)=0
DECLARE @ProjectRowCount int=(select COUNT(ProjectId) from #tempInsertMissingUserModificationMissingChoices)
WHILE (@ProjectRowCount >0)
BEGIN
DECLARE @ProjectId INT =(select  ProjectId  from #tempInsertMissingUserModificationMissingChoices WHERE RowNo=@ProjectRowCount);
IF(@ProjectId1 !=0)
	begin
	set @ProjectRowCount=1
	set @ProjectId= @ProjectId1
	end
--create temp table 
DROP TABLE IF EXISTS #ChoiceCodesInSegmnetDesc;
CREATE TABLE #ChoiceCodesInSegmnetDesc (ProjectId INT, SectionId INT,CustomerId INT, ChoiceCode INT,SegmentStatusId int,SegmentId int,ModifiedBy INT);
DROP TABLE IF EXISTS #TempProjectSegmentStatusView;
--Select Segmentsdescription which having Choices
SELECT PS.SectionId, PS.SegmentDescription,PS.ProjectId,PS.SegmentSource,
PS.CustomerId,PS.SegmentStatusId,PS.SegmentId ,PS.ModifiedBy, ROW_NUMBER() OVER(ORDER BY PS.SegmentStatusId ASC) AS RowId
INTO #TempProjectSegmentStatusView
FROM  ProjectSegment PS WITH(NOLOCK) 
WHERE PS.ProjectId = @ProjectId and ISNULL(PS.IsDeleted,0)=0    
AND  PS.SegmentDescription LIKE '%{CH#%' 
AND  PS.SegmentDescription NOT LIKE '%{CH#{CH#%'
AND PS.SegmentStatusId IS NOT NULL
 --Fetch choice code from SegmentDescription
DECLARE @LoopCount INT = (SELECT COUNT(1) AS TotalRows FROM #TempProjectSegmentStatusView)
DECLARE @SegmentDescription NVARCHAR(MAX) = '';
DECLARE @SectionId INT = 0;
DECLARE @SegmentStatusId INT = 0;
DECLARE @SegmentId INT = 0;
DECLARE @ModifiedBy INT = 0;
WHILE @LoopCount > 0
BEGIN
SELECT @SegmentDescription = TPSSV.SegmentDescription, @SectionId = TPSSV.SectionId ,
@CustomerId =TPSSV.CustomerId,@SegmentStatusId=TPSSV.SegmentStatusId ,@SegmentId=TPSSV.SegmentId,
@ModifiedBy =TPSSV.ModifiedBy
FROM #TempProjectSegmentStatusView TPSSV WHERE RowId = @LoopCount;
INSERT INTO #ChoiceCodesInSegmnetDesc(ProjectId,SectionId,CustomerId,ChoiceCode,SegmentStatusId,SegmentId,ModifiedBy)
SELECT @ProjectId AS ProjectId, @SectionId AS SectionId,@CustomerId as CustomerId,Ids,@SegmentStatusId AS SegmentStatusId,@SegmentId AS SegmentId ,@ModifiedBy as ModifiedBy
FROM [dbo].[fn_GetIdSegmentDescription](@SegmentDescription,'{CH#')
SET @LoopCount = @LoopCount - 1;
END;
--Filter missing choices data from #TempProjectSegmentChoice
drop table if exists #TempProjectSegmentChoice1
SELECT DISTINCT CCIS.* INTO #TempProjectSegmentChoice1
FROM #ChoiceCodesInSegmnetDesc CCIS 
LEFT OUTER JOIN ProjectSegmentChoice PSC  WITH(NOLOCK)
ON PSC.SegmentChoiceCode = CCIS.ChoiceCode and PSC.ProjectId=CCIS.ProjectId
AND CCIS.SectionId=PSC.SectionId AND  CCIS.SegmentId=PSC.SegmentId and CCIS.SegmentStatusId =PSC.SegmentStatusId
WHERE PSC.SegmentChoiceCode IS NULL 
--Filter missing choices data from #TempProjectChoiceOption1
DROP TABLE IF EXISTS  #TempProjectChoiceOption1
 SELECT DISTINCT SortOrder,	OptionJson	,ChoiceOptionCode	,SC.CreateDate	,SC.ModifiedDate,
 tblins.ProjectId	,tblins.SectionId	,tblins.CustomerId	,tblins.ChoiceCode	,tblins.SegmentStatusId	,tblins.SegmentId	,tblins.ModifiedBy 
 INTO #TempProjectChoiceOption1
  FROM 
 #TempProjectSegmentChoice1 tblins    
 INNER JOIN SLCMaster..SegmentChoice SC WITH(NOLOCK) ON SC.SegmentChoiceCode=tblins.ChoiceCode  
 INNER JOIN SLCMaster..ChoiceOption SLCMCO WITH(NOLOCK) ON  SC.SegmentChoiceId=SLCMCO.SegmentChoiceId 
 
--Filter missing choices data from ##TempProjectSelectedChoiceOption
drop table if exists #TempProjectSelectedChoiceOption1
 SELECT DISTINCT CCIS.*,SLCMSCO.ChoiceOptionCode	, 	SLCMSCO.IsSelected
 INTO #TempProjectSelectedChoiceOption1
 FROM #TempProjectSegmentChoice1 CCIS 
 INNER JOIN SLCMaster..SegmentChoice SC WITH(NOLOCK) ON SC.SegmentChoiceCode=CCIS.ChoiceCode  
 INNER JOIN SLCMaster..ChoiceOption SLCMCO WITH(NOLOCK) ON  SC.SegmentChoiceId=SLCMCO.SegmentChoiceId 
 INNER JOIN SLCMaster..SelectedChoiceOption SLCMSCO WITH(NOLOCK) ON SLCMSCO.SegmentChoiceCode=CCIS.ChoiceCode
 AND SLCMCO.ChoiceOptionCode=SLCMSCO.ChoiceOptionCode
 
--if missing data is present in filtered table then insert into original table from SLCMaster
IF((select count(1) #TempProjectSegmentChoice1)>0)
BEGIN
INSERT INTO ProjectSegmentChoice
SELECT DISTINCT
 tblins.SectionId	
,tblins.SegmentStatusId	
,tblins.SegmentId	
,SMSC.ChoiceTypeId	 
,tblins.ProjectId	
,tblins.CustomerId	
,'U' AS SegmentChoiceSource
,tblins.ChoiceCode	
,isnull (tblins.ModifiedBy,0)
,GETUTCDATE() AS CreateDate
,NULL AS ModifiedBy	
,NULL	AS ModifiedDate
,NULL AS SLE_DocID	
,NULL AS  SLE_SegmentID
,NULL AS SLE_StatusID	
,NULL AS SLE_ChoiceNo	
,SMSC.ChoiceTypeId
,null AS A_SegmentChoiceId
,0 AS IsDeleted
 FROM SLCMaster..SegmentChoice SMSC WITH (NOLOCK) inner join 
#TempProjectSegmentChoice1 tblins on tblins.ChoiceCode=SMSC.SegmentChoiceCode
 WHERE tblins.ChoiceCode=SMSC.SegmentChoiceCode
 END
 
--if missing data is present in filtered table then insert into original table from SLCMaster
  if((select count(1) FROM #TempProjectChoiceOption1)>0)
  BEGIN
 INSERT INTO ProjectChoiceOption
 SELECT DISTINCT
 PSC.SegmentChoiceId	
,tblins.SortOrder	
,'U' AS ChoiceOptionSource
,tblins.OptionJson	
,PSC.ProjectId	
,PSC.SectionId	
,PSC.CustomerId	
,tblins.ChoiceOptionCode	
,PSC.CreatedBy	
,GETUTCDATE() AS CreateDate
,PSC.CreatedBy		
,NULL AS ModifiedDate
,NULL AS A_ChoiceOptionId
,0 AS IsDeleted
 FROM ProjectSegmentChoice PSC WITH(NOLOCK) 
 INNER JOIN #TempProjectChoiceOption1 tblins WITH(NOLOCK) ON 
 tblins.ChoiceCode=PSC.SegmentChoiceCode 
 AND PSC.ProjectId=tblins.ProjectId AND PSC.SectionId=tblins.SectionId and
  PSC.SegmentStatusId=tblins.SegmentStatusId AND PSC.SegmentId=tblins.SegmentId  
 END
--if missing data is present in filtered table then insert into original table from SLCMaster
IF((select count(1) #TempProjectSelectedChoiceOption1)>0)
BEGIN
INSERT INTO SelectedChoiceOption
SELECT DISTINCT
tblins.ChoiceCode, 
SCO.ChoiceOptionCode, 
'U' AS ChoiceOptionSource,
SCO.IsSelected, 
tblins.SectionId, 
tblins.ProjectId,
tblins.CustomerId AS CustomerId,NULL AS OptionJson,0 AS IsDeleted
 FROM SLCMaster..SelectedChoiceOption SCO WITH (NOLOCK) INNER JOIN
#TempProjectSelectedChoiceOption1 tblins on tblins.ChoiceCode=SCO.SegmentChoiceCode
INNER JOIN #TempProjectChoiceOption1 tpco ON tpco.ChoiceOptionCode=SCO.ChoiceOptionCode 
 WHERE tblins.ChoiceCode=SCO.SegmentChoiceCode   
 END
   
  
 SET @ProjectRowCount = @ProjectRowCount-1;
 END