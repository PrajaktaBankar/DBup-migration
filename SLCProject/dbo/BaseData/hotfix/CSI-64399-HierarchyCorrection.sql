USE SLCProject

/*
Server - Execute on server 003
Customer Support 64399: SLC Cannot Decrease Indent
*/
GO

UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369158;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369159;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369160;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369161;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369162;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369163;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369164;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369165;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369166;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369167;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369168;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369169;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369171;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369172;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369173;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369174;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369176;

UPDATE PSS SET IndentLevel = 5 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369179;
UPDATE PSS SET IndentLevel = 5 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369181;

UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369189;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369196;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369202;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369203;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369204;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369205;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369212;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369213;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369214;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369221;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369222;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369227;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369234;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369235;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369238;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369239;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369244;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369245;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369246;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369257;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369280;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369281;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369282;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369301;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369302;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369303;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369304;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369305;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369306;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369307;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369308;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369309;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369314;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369320;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369321;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369326;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369327;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369328;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369329;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369330;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369331;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369332;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369333;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369334;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369338;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369339;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369340;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369021;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369022;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369033;
UPDATE PSS SET IndentLevel = 4 FROM ProjectSegmentStatus PSS WITH(NOLOCK) WHERE SegmentStatusId = 894369034;

GO

DECLARE @SectionId INT = 15638308;

DROP TABLE IF EXISTS #IndentLevelWiseParentIds;
CREATE TABLE #IndentLevelWiseParentIds(
 IndentLevel INT,
 ParentSegmentStatusId BIGINT);

INSERT INTO #IndentLevelWiseParentIds(IndentLevel,ParentSegmentStatusId) VALUES (1,-1);
INSERT INTO #IndentLevelWiseParentIds(IndentLevel,ParentSegmentStatusId) VALUES (2,-1);
INSERT INTO #IndentLevelWiseParentIds(IndentLevel,ParentSegmentStatusId) VALUES (3,-1);
INSERT INTO #IndentLevelWiseParentIds(IndentLevel,ParentSegmentStatusId) VALUES (4,-1);
INSERT INTO #IndentLevelWiseParentIds(IndentLevel,ParentSegmentStatusId) VALUES (5,-1);
INSERT INTO #IndentLevelWiseParentIds(IndentLevel,ParentSegmentStatusId) VALUES (6,-1);
INSERT INTO #IndentLevelWiseParentIds(IndentLevel,ParentSegmentStatusId) VALUES (7,-1);
INSERT INTO #IndentLevelWiseParentIds(IndentLevel,ParentSegmentStatusId) VALUES (8,-1);

DROP TABLE IF EXISTS #tempSectionPSS;

SELECT ROW_NUMBER() over(ORDER BY PSS.SequenceNumber) AS RowId, PSS.SegmentStatusId , PSS.ParentSegmentStatusId,
 PSS.IndentLevel, PSS.SequenceNumber, -1 AS NewPSegmentStatusId INTO #tempSectionPSS
FROM ProjectSegmentStatus PSS WITH(NOLOCK) where PSS.SectionId = @SectionId and ISNULL(PSS.IsDeleted,0) =0 order by SequenceNumber;


DECLARE @Cntr INT = 2;
DECLARE @RowCnt INT = (SELECT COUNT(*)-1 FROM #tempSectionPSS);
DECLARE @tPSegStatusId INT = (SELECT SegmentStatusId FROM #tempSectionPSS WHERE SequenceNumber = 0)
UPDATE #IndentLevelWiseParentIds SET ParentSegmentStatusId = @tPSegStatusId WHERE IndentLevel = 1;

DECLARE @CurrIndtLevel INT, @CurrSSId BIGINT, @CurrPrntSSId BIGINT, @expctPrntSSId BIGINT;

WHILE(@Cntr <= @RowCnt)
BEGIN
	SELECT @CurrIndtLevel = IndentLevel, @CurrSSId = SegmentStatusId, @CurrPrntSSId = ParentSegmentStatusId FROM #tempSectionPSS WHERE RowId = @Cntr;
	SELECT @expctPrntSSId = ParentSegmentStatusId FROM #IndentLevelWiseParentIds WHERE IndentLevel = @CurrIndtLevel;
	IF(@CurrPrntSSId <> @expctPrntSSId)
		UPDATE #tempSectionPSS SET NewPSegmentStatusId = @expctPrntSSId WHERE RowId = @Cntr;
	IF(@CurrIndtLevel <=8)
		UPDATE #IndentLevelWiseParentIds SET ParentSegmentStatusId = @CurrSSId WHERE IndentLevel = (@CurrIndtLevel+1);

	SET @Cntr = @Cntr+1;
END;

-- CHECK IF INDENT LEVELS NEED TO BE CORRECTED
SET @Cntr = (SELECT COUNT(1) FROM #tempSectionPSS WHERE NewPSegmentStatusId >-1);
IF(@Cntr > 0)
BEGIN
	SELECT 'Updating ParentSegmentStatusId of ' + CAST(@Cntr AS NVARCHAR(20)) + ' segments...' AS [Action];

	UPDATE PSS SET PSS.ParentSegmentStatusId = tPSS.NewPSegmentStatusId FROM ProjectSegmentStatus PSS WITH(NOLOCK) INNER JOIN #tempSectionPSS tPSS
	ON PSS.SegmentStatusId = tPSS.SegmentStatusId WHERE PSS.SectionId = @SectionId AND tPSS.NewPSegmentStatusId <> -1;
 
	SELECT SegmentStatusId, ParentSegmentStatusId AS OldParentSSId, NewPSegmentStatusId AS NewParentSSIT from #tempSectionPSS WHERE NewPSegmentStatusId <> -1 ORDER BY RowId;
END
ELSE
	SELECT 'Parent-Child relationship for this section is correct' AS Result;